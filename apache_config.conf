# SSL Stapling Configuration - Global level
SSLUseStapling on
SSLStaplingCache "shmcb:logs/stapling-cache(150000)"
SSLSessionCache shmcb:/var/run/apache2/ssl_scache(512000)
SSLSessionCacheTimeout 300

<IfModule mod_ssl.c>
<VirtualHost *:443>
    ServerAdmin admin@wplabs.se
    # Set DocumentRoot to the public directory where static files are
    DocumentRoot /var/www/wplabs/public
    ServerName wplabs.se
    ServerAlias www.wplabs.se

    # Enable HTTP/2
    Protocols h2 http/1.1
    
    # Root project directory settings
    <Directory /var/www/wplabs>
        Options -Indexes +FollowSymLinks
        AllowOverride All
        Require all granted
        
        # Enable .htaccess files
        <FilesMatch "^\.ht">
            Require all denied
        </FilesMatch>
    </Directory>
    
    # Public directory settings - this is the DocumentRoot
    <Directory /var/www/wplabs/public>
        Options -Indexes +FollowSymLinks
        AllowOverride None
        Require all granted
        
        # Add proper MIME types
        AddType application/javascript .js
        AddType application/json .json
        AddType text/css .css
        
        # Enable browser caching for static assets
        <IfModule mod_expires.c>
            ExpiresActive On
            ExpiresByType image/jpg "access plus 1 year"
            ExpiresByType image/jpeg "access plus 1 year"
            ExpiresByType image/gif "access plus 1 year"
            ExpiresByType image/png "access plus 1 year"
            ExpiresByType image/svg+xml "access plus 1 year"
            ExpiresByType text/css "access plus 1 month"
            ExpiresByType application/javascript "access plus 1 month"
            ExpiresByType application/x-javascript "access plus 1 month"
        </IfModule>
        
        # Enable compression
        <IfModule mod_deflate.c>
            AddOutputFilterByType DEFLATE text/html text/plain text/xml text/css application/javascript application/json
        </IfModule>
        
        # Default index files
        DirectoryIndex index.html index.htm
    </Directory>
    
    # Proxy API requests to Node.js server
    <Location /api>
        ProxyPass http://localhost:3000/api
        ProxyPassReverse http://localhost:3000/api
        
        # Set headers for proxy
        ProxyPreserveHost On
        RequestHeader set X-Forwarded-Proto "https"
        RequestHeader set X-Forwarded-Port "443"
    </Location>
    
    # Security Headers
    <IfModule mod_headers.c>
        # Enable Cross-site Script (XSS) filter built into browsers
        Header always set X-XSS-Protection "1; mode=block"
        # Prevent MIME-sniffing
        Header always set X-Content-Type-Options "nosniff"
        # Don't allow the site to be framed
        Header always set X-Frame-Options "SAMEORIGIN"
        # Enable browser features selectively
        Header always set Permissions-Policy "geolocation=(), midi=(), camera=(), microphone=()"
        # Block access to sensitive directories
        <DirectoryMatch "(^|/)\.">
            Require all denied
        </DirectoryMatch>
    </IfModule>
    
    # Logging
    ErrorLog ${APACHE_LOG_DIR}/error.log
    CustomLog ${APACHE_LOG_DIR}/access.log combined
    
    # Rewrite Engine for URLs
    RewriteEngine On
    
    # Fallback for client-side routing - redirect non-file/directory requests to index.html
    RewriteCond %{REQUEST_FILENAME} !-f
    RewriteCond %{REQUEST_FILENAME} !-d
    RewriteCond %{REQUEST_URI} !^/api/
    RewriteRule . /index.html [L]

    # SSL Configuration
    SSLEngine on
    SSLCertificateFile /etc/letsencrypt/live/wplabs.se-0002/fullchain.pem
    SSLCertificateKeyFile /etc/letsencrypt/live/wplabs.se-0002/privkey.pem
    Include /etc/letsencrypt/options-ssl-apache.conf
    
    # OCSP Stapling
    SSLUseStapling on
</VirtualHost>
</IfModule>
